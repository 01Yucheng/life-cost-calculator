import streamlit as st
import pandas as pd

# --- 1. é¡µé¢é…ç½® ---
st.set_page_config(page_title="ä¸œäº¬ç”Ÿæ´»æˆæœ¬å¯¹æ¯”-AIè¾…åŠ©ç‰ˆ", layout="wide")

st.title("ğŸ‡¯ğŸ‡µ ä¸œäº¬ç”Ÿæ´»æˆæœ¬è®¡ç®—å™¨ (AI è¾…åŠ©ç‰ˆ)")

# ä¾§è¾¹æ è¯´æ˜ï¼šå¦‚ä½•è·å¾—æ•°æ®
with st.sidebar:
    st.header("ğŸ’¡ å¦‚ä½•ä½¿ç”¨")
    st.write("1. **è¯¢é—® AI**ï¼šåœ¨å¯¹è¯æ¡†é—®æˆ‘ç±»ä¼¼ã€ä» A ç«™åˆ° B ç«™ç”µè½¦å¤šä¹…ï¼Œå¤šå°‘é’±ï¼Ÿã€")
    st.write("2. **å½•å…¥æ•°æ®**ï¼šå°†æˆ‘ç»™å‡ºçš„ç»“æœå¡«å…¥å³ä¾§è¡¨æ ¼ã€‚")
    st.write("3. **æŸ¥çœ‹åˆ†æ**ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨è®¡ç®—æœˆåº¦æ€»æ”¯å‡ºã€‚")
    st.divider()
    st.info("æ³¨ï¼šè®¡ç®—é€»è¾‘æŒ‰æ¯æœˆ 4.33 å‘¨è®¡ç®—ã€‚")

# --- 2. æ•°æ®ç¼–è¾‘åŒº ---

# åˆå§‹åŒ–è¡¨æ ¼åˆ—å
columns = [
    "æˆ¿æºåç§°", "æˆ¿ç§Ÿ(å††)", "ç®¡ç†è´¹(å††)", "æ°´ç”µç½‘(ä¼°)", "é£Ÿè´¹/ç”Ÿæ´»", 
    "å•ç¨‹æ—¶é—´(åˆ†)", "å•ç¨‹ç¥¨ä»·(å††)", "Aå‘¨é¢‘", "Bå‘¨é¢‘"
]

if "df" not in st.session_state:
    # é»˜è®¤ä¸€è¡Œåˆå§‹æ•°æ®
    st.session_state.df = pd.DataFrame([{
        "æˆ¿æºåç§°": "ç¤ºä¾‹æˆ¿æº", "æˆ¿ç§Ÿ(å††)": 85000, "ç®¡ç†è´¹(å††)": 5000, 
        "æ°´ç”µç½‘(ä¼°)": 15000, "é£Ÿè´¹/ç”Ÿæ´»": 45000, 
        "å•ç¨‹æ—¶é—´(åˆ†)": 30, "å•ç¨‹ç¥¨ä»·(å††)": 210, "Aå‘¨é¢‘": 5, "Bå‘¨é¢‘": 0
    }])

st.subheader("1. å½•å…¥æˆ¿æºä¸é€šå‹¤ä¿¡æ¯")
# ä½¿ç”¨ data_editor å®ç° Excel èˆ¬çš„ç¼–è¾‘ä½“éªŒ
edited_df = st.data_editor(
    st.session_state.df, 
    num_rows="dynamic", 
    use_container_width=True,
    key="house_editor"
)

# åŒæ­¥ session_state
st.session_state.df = edited_df

# --- 3. è‡ªåŠ¨è®¡ç®—ä¸å¯¹æ¯”æŠ¥å‘Š ---

st.divider()
st.subheader("2. æœˆåº¦æ€»æ”¯å‡ºåˆ†ææ±‡æ€»")

if not edited_df.empty:
    res = edited_df.copy().fillna(0)
    
    # è®¡ç®—æœˆé€šå‹¤æ¬¡æ•°ï¼ˆå¾€è¿”ï¼‰
    res["æœˆé€šå‹¤æ€»æ¬¡æ•°"] = (res["Aå‘¨é¢‘"] + res["Bå‘¨é¢‘"]) * 4.33 * 2
    
    # è®¡ç®—å›ºå®šæˆæœ¬ï¼ˆæˆ¿ç§Ÿ+ç®¡ç†è´¹+æ°´ç”µ+é£Ÿè´¹ï¼‰
    res["æœˆå›ºå®šæˆæœ¬"] = res["æˆ¿ç§Ÿ(å††)"] + res["ç®¡ç†è´¹(å††)"] + res["æ°´ç”µç½‘(ä¼°)"] + res["é£Ÿè´¹/ç”Ÿæ´»"]
    
    # è®¡ç®—é€šå‹¤æˆæœ¬
    res["æœˆé€šå‹¤æ”¯å‡º"] = res["å•ç¨‹ç¥¨ä»·(å††)"] * res["æœˆé€šå‹¤æ€»æ¬¡æ•°"]
    
    # è®¡ç®—æ€»æ”¯å‡º
    res["é¢„è®¡æœˆæ€»æ”¯å‡º(å††)"] = res["æœˆå›ºå®šæˆæœ¬"] + res["æœˆé€šå‹¤æ”¯å‡º"]
    
    # æ•´ç†æ˜¾ç¤ºåˆ—
    final_display = res[[
        "æˆ¿æºåç§°", "é¢„è®¡æœˆæ€»æ”¯å‡º(å††)", "æœˆå›ºå®šæˆæœ¬", "æœˆé€šå‹¤æ”¯å‡º", "å•ç¨‹æ—¶é—´(åˆ†)"
    ]].sort_values("é¢„è®¡æœˆæ€»æ”¯å‡º(å††)")

    # ç»“æœè¡¨æ ¼
    st.dataframe(final_display, use_container_width=True)
    
    # å¯è§†åŒ–å¯¹æ¯”ï¼ˆå¯é€‰ï¼‰
    if len(final_display) > 1:
        st.bar_chart(data=final_display, x="æˆ¿æºåç§°", y="é¢„è®¡æœˆæ€»æ”¯å‡º(å††)")

else:
    st.warning("è¯·åœ¨ä¸Šæ–¹è¡¨æ ¼ä¸­æ·»åŠ æˆ¿æºæ•°æ®ã€‚")
